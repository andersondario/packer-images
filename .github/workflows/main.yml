name: Build and Publish VM Image

on:
  push:
    branches:
      - main

env:
  HASHICORP_CLOUD_TOKEN: ${{ secrets.HASHICORP_CLOUD_TOKEN }}
  PROMETHEUS_BASIC_AUTH_PASS: ${{ secrets.PROMETHEUS_BASIC_AUTH_PASS }}

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
        matrix:
          subfolder: [ prometheus, grafana ]
        fail-fast: true
    needs: [ setup ]

    steps:
    - name: Set up Packer
      uses: hashicorp/setup-packer@v1
      
    - name: Set up Ansible
      uses: hashicorp/setup-ansible@v1
    
    - name: Build image
      run: | 
        cd $subfolder
        sh pre-build.sh
        packer build .
      
    # - name: Publish image
    #   run: packer push -name packer-$subfolder-$TIMESTAMP .
    